<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate AD-AS Model Learning Environment</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKZC0svKNUROgsE7FVU2TwuUmdlNP9GGUo2CRI3BlgN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .katex { font-size: 1.1em; }
        .section-title { font-family: 'Source Serif 4', serif; font-weight: 600; }
        .axis-label { font-size: 14px; }
        .tab { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-active { border-color: #0ea5e9; color: #0284c7; background-color: #f0f9ff; }
        .story-highlight { background-color: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 0.75rem; border-radius: 0.25rem; }
        .challenge-card { background-color: #f8fafc; border: 1px solid #e2e8f0; }
        .challenge-card.completed { border-left: 4px solid #22c55e; }
        /* Chat styles */
        .chat-bubble-user { background-color: #e0f2fe; }
        .chat-bubble-ai { background-color: #f1f5f9; }
        .chat-container { max-height: 400px; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-900 tracking-tight sm:text-5xl section-title">The Ultimate AD-AS Environment</h1>
            <p class="mt-3 text-lg text-slate-600 max-w-4xl mx-auto">Explore theory, solve policy challenges, and connect models to real-world data.</p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls & Tutor -->
            <div class="xl:col-span-3 space-y-6">
                <div id="controls-panel" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Parameters</h2>
                    <div id="controls-container" class="space-y-5"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">AI Economics Tutor</h2>
                    <div id="chat-container" class="flex-grow overflow-y-auto pr-2 space-y-4 mb-4 min-h-[200px]">
                        <div class="chat-bubble-ai p-3 rounded-lg"><p class="text-sm text-slate-700">Set up a scenario and ask a question!</p></div>
                    </div>
                    <div class="mt-auto">
                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Why did prices rise?" class="flex-grow border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <button id="chat-submit" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Ask</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Visualizations & Modes -->
            <div class="xl:col-span-6 bg-white p-4 sm:p-6 rounded-2xl shadow-xl border border-slate-200 space-y-4">
                <!-- Tab Controls -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-explorer" class="tab tab-active whitespace-nowrap py-3 px-1 font-medium text-sm">Explorer Mode</button>
                        <button id="tab-challenge" class="tab text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 font-medium text-sm">Challenge Mode</button>
                        <button id="tab-empirical" class="tab text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 font-medium text-sm">Empirical Bridge</button>
                    </nav>
                </div>

                <!-- Main Content Area -->
                <div id="main-content-area">
                    <!-- Explorer Mode Content -->
                    <div id="content-explorer">
                        <div class="flex justify-center mb-4">
                            <button id="guided-tour-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-sm">Start Guided Tour</button>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-700 text-center mb-2">AD-AS Diagram & Dynamic Path</h3>
                        <div id="adas-chart-container"></div>
                        <div id="time-slider-container" class="mt-2 px-4"></div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                             <div><h3 class="text-lg font-semibold text-slate-700 text-center mb-2">Output Path</h3><div id="y-path-chart-container"></div></div>
                             <div><h3 class="text-lg font-semibold text-slate-700 text-center mb-2">Price Path</h3><div id="p-path-chart-container"></div></div>
                        </div>
                    </div>
                    <!-- Challenge Mode Content -->
                    <div id="content-challenge" class="hidden">
                        <div id="challenge-selection" class="p-4">
                            <h3 class="text-xl font-semibold text-slate-700 text-center mb-4">Policy Challenges</h3>
                            <div id="challenge-list" class="space-y-4"></div>
                        </div>
                        <div id="challenge-view" class="hidden">
                             <button id="back-to-challenges" class="mb-4 text-sm text-sky-600 hover:text-sky-800">&larr; Back to Challenges</button>
                             <h3 id="challenge-title" class="text-xl font-semibold text-slate-700 text-center mb-2"></h3>
                             <p id="challenge-description" class="text-center text-sm text-slate-600 mb-4"></p>
                             <div id="challenge-chart-container"></div>
                             <div id="challenge-feedback" class="mt-4 text-center"></div>
                        </div>
                    </div>
                    <!-- Empirical Bridge Content -->
                    <div id="content-empirical" class="hidden">
                        <h3 class="text-xl font-semibold text-slate-700 text-center mb-4">Connect Theory to Reality</h3>
                        <div class="text-center mb-6">
                            <button id="load-2008-data" class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors">Load 2008 Financial Crisis Data</button>
                        </div>
                        <div id="empirical-chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Analysis -->
            <div class="xl:col-span-3 bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <div id="analysis-content">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Analysis</h2>
                    <div id="story-container" class="text-sm text-slate-700 leading-relaxed mb-6"></div>
                    <div id="equations-container" class="space-y-4 text-sm"></div>
                    <div id="next-steps-container" class="mt-6 border-t pt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- STATE & CONFIG ---
        let state = {};
        let activeMode = 'explorer';
        const DURATION = 750;
        const EASE = d3.easeCubicOut;
        const COLORS = { ad: "#2563eb", sras: "#db2777", lras: "#16a34a", path: "#dc2626", y_path: "#2563eb", p_path: "#991b1b", equilibrium: "#16a34a", real_data: "#f59e0b" };
        const params = {
            a: { min: 80, max: 150, value: 120, step: 5, label: "AD Intercept", symbol: "a" },
            b: { min: 1, max: 30, value: 10, step: 1, label: "AD Slope Param.", symbol: "b" },
            Y_bar: { min: 80, max: 120, value: 100, step: 1, label: "Potential Output", symbol: "\\bar{Y}" },
            c: { min: 0.5, max: 20, value: 5, step: 0.5, label: "Price Inertia", symbol: "c" },
            P0: { min: 0.5, max: 4.0, value: 1.0, step: 0.05, label: "Initial Price", symbol: "P₀" },
            T: { min: 5, max: 50, value: 20, step: 1, label: "Time Horizon", symbol: "T" }
        };
        const challenges = {
            'demand_bust': {
                title: "Combat a Recession",
                description: "A negative demand shock has occurred. Use fiscal policy (AD Intercept 'a') to return output to potential (within ±1 unit) in 10 periods or less.",
                initialState: { a: 100, b: 10, Y_bar: 100, c: 5, P0: 2.0, T: 15 },
                policyTool: 'a',
                goal: (s) => Math.abs(s.time_series[10].y - s.Y_bar) <= 1
            }
        };
        const empiricalData = {
            '2008_crisis': {
                name: "2008 Financial Crisis",
                initialState: { a: 125, b: 15, Y_bar: 100, c: 8, P0: 2.5, T: 20 },
                shock: { param: 'a', newValue: 95 },
                real_path: [ {t:0, y:100, p:2.5}, {t:1, y:99, p:2.4}, {t:2, y:96, p:2.2}, {t:3, y:97, p:2.1}, {t:4, y:98.5, p:2.15}, {t:5, y:100, p:2.2} ]
            }
        };
        const guidedTour = [
            { params: { a: 120, P0: 2.0 }, text: "Here is the economy in its long-run equilibrium. Output (Y) is at its potential (Ȳ), and the price level (P) is stable." },
            { params: { a: 100 }, text: "Now, a negative demand shock hits, like a fall in consumer confidence. The AD curve shifts left. In the short-run, prices are sticky, so the economy moves to a new equilibrium with lower output (a recession) and the same price level." },
            { params: {}, text: "With output below potential, there's downward pressure on prices. The SRAS curve begins to shift down as firms slowly lower prices." },
            { params: {}, text: "As prices fall, the economy moves down along the new AD curve. Output begins to recover, and the recessionary gap shrinks." },
            { params: {}, text: "This process continues until the economy reaches a new long-run equilibrium at potential output, but with a permanently lower price level. The recession is over." }
        ];

        // --- D3 & DOM SETUP ---
        function setupChart(containerId, margin) {
            const container = document.getElementById(containerId);
            let width = container.clientWidth - margin.left - margin.right;
            let height = width * 0.6;
            if (width < 100) { width = 300; height = 180; } // Fallback for hidden elements
            const svg = d3.select(`#${containerId}`).append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            return { svg, width, height };
        }
        const adasChart = setupChart('adas-chart-container', { top: 20, right: 20, bottom: 40, left: 50 });
        const yPathChart = setupChart('y-path-chart-container', { top: 10, right: 10, bottom: 30, left: 40 });
        const pPathChart = setupChart('p-path-chart-container', { top: 10, right: 10, bottom: 30, left: 40 });
        const challengeChart = setupChart('challenge-chart-container', { top: 20, right: 20, bottom: 40, left: 50 });
        const empiricalChart = setupChart('empirical-chart-container', { top: 20, right: 20, bottom: 40, left: 50 });

        // --- CORE LOGIC ---
        function calculateState(currentParams) {
            const s = {};
            Object.keys(params).forEach(key => s[key] = +currentParams[key].value);
            const { a, b, Y_bar, c, P0, T } = s;
            const lambda_adjust = 1.0 / c;
            const Y = [0]; const P = [0];
            P[0] = P0; Y[0] = a - b * P[0];
            for (let t = 1; t < T; t++) {
                P[t] = P[t-1] + lambda_adjust * (Y[t-1] - Y_bar);
                P[t] = Math.max(P[t], 1e-6);
                Y[t] = a - b * P[t];
            }
            s.time_series = d3.range(T).map(i => ({t: i, y: Y[i], p: P[i]}));
            s.P_star = (a - Y_bar) / b;
            return s;
        }
        
        function render() {
            const currentParams = {};
            Object.keys(params).forEach(key => currentParams[key] = {value: d3.select(`#${key}`).property("value")});
            state = calculateState(currentParams);
            
            Object.entries(params).forEach(([key, p]) => {
                const val = state[key];
                d3.select(`#${key}-value`).text(parseFloat(val).toFixed(p.step < 1 ? 2 : 0));
            });
            
            if (activeMode === 'explorer') {
                renderExplorerMode(state);
            }
            renderAnalysis(state);
        }

        function renderExplorerMode(s) {
            renderAdAsChart(adasChart.svg, adasChart.width, adasChart.height, s);
            renderPathChart(yPathChart.svg, yPathChart.width, yPathChart.height, s, 'y');
            renderPathChart(pPathChart.svg, pPathChart.width, pPathChart.height, s, 'p');
            renderTimeSlider(s);
        }

        function renderAdAsChart(svg, width, height, s, realDataPath = null, currentTime = -1) {
            const t = d3.transition().duration(DURATION).ease(EASE);
            const { time_series, Y_bar, P_star, a, b } = s;
            
            const allY = [...time_series.map(d => d.y), Y_bar, ...(realDataPath ? realDataPath.map(d => d.y) : [])];
            const allP = [...time_series.map(d => d.p), P_star, ...(realDataPath ? realDataPath.map(d => d.p) : [])];

            const xScale = d3.scaleLinear().domain([d3.min(allY) * 0.9, d3.max(allY) * 1.1]).range([0, width]);
            const yScale = d3.scaleLinear().domain([d3.min(allP) * 0.9, d3.max(allP) * 1.1]).range([height, 0]);

            svg.select(".x-axis").transition(t).call(d3.axisBottom(xScale));
            svg.select(".y-axis").transition(t).call(d3.axisLeft(yScale));

            const ad_line_data = [{y: a - b * yScale.domain()[0], p: yScale.domain()[0]}, {y: a - b * yScale.domain()[1], p: yScale.domain()[1]}];
            svg.select(".ad-curve").datum(ad_line_data).transition(t).attr("d", d3.line().x(d => xScale(d.y)).y(d => yScale(d.p)));
            svg.select(".lras-curve").transition(t).attr("x1", xScale(Y_bar)).attr("x2", xScale(Y_bar));

            const pathData = (currentTime === -1) ? time_series : time_series.slice(0, currentTime + 1);
            const path = svg.select(".dynamic-path").datum(pathData);
            path.transition(t).attr("d", d3.line().x(d => xScale(d.y)).y(d => yScale(d.p)));
            
            svg.select(".start-point").transition(t).attr("cx", xScale(time_series[0].y)).attr("cy", yScale(time_series[0].p));
            svg.select(".equilibrium-point").transition(t).attr("cx", xScale(Y_bar)).attr("cy", yScale(P_star));
            
            const srasPrice = (currentTime <= 0) ? time_series[0].p : time_series[currentTime - 1].p;
            svg.select(".sras-curve").transition(t)
                .attr("x1", 0).attr("x2", width)
                .attr("y1", yScale(srasPrice)).attr("y2", yScale(srasPrice))
                .style("opacity", currentTime === -1 ? 0 : 1);
        }

        function renderPathChart(svg, width, height, s, variable) { /* ... same as before ... */ }

        function renderAnalysis(s) { /* ... same as before ... */ }

        function renderTimeSlider(s) {
            const container = d3.select('#time-slider-container');
            container.html(''); // Clear previous
            container.append('label').attr('for', 'time-scrubber').attr('class', 'text-sm font-medium text-slate-600 mr-2').text(`Time: t=`);
            container.append('span').attr('id', 'time-value').attr('class', 'text-sm font-semibold text-slate-800').text('All');
            const slider = container.append('input')
                .attr('type', 'range').attr('id', 'time-scrubber')
                .attr('min', 0).attr('max', s.T - 1).attr('value', s.T - 1)
                .attr('class', 'w-full');
            
            slider.on('input', function() {
                const t = +this.value;
                d3.select('#time-value').text(t);
                renderAdAsChart(adasChart.svg, adasChart.width, adasChart.height, s, null, t);
            });
        }
        
        // --- NEW MODE HANDLERS ---
        function setupTabs() { /* ... same as before ... */ }
        function renderChallengeSelection() { /* ... same as before ... */ }
        function startChallenge(key) { /* ... same as before ... */ }
        function setupEmpiricalBridge() { /* ... same as before ... */ }
        
        // --- GUIDED TOUR ---
        function startGuidedTour() {
            let currentStep = 0;
            const tourButton = d3.select("#guided-tour-btn");
            tourButton.property("disabled", true).text("Tour in Progress...");

            function nextStep() {
                if (currentStep >= guidedTour.length) {
                    tourButton.property("disabled", false).text("Start Guided Tour");
                    return;
                }
                const step = guidedTour[currentStep];
                
                Object.entries(step.params).forEach(([key, value]) => {
                    d3.select(`#${key}`).property('value', value).dispatch('input');
                });

                setTimeout(() => {
                     d3.select("#story-container").html(`<div class="story-highlight"><b>Tour Step ${currentStep + 1}:</b> ${step.text}</div>`);
                     currentStep++;
                     setTimeout(nextStep, 4000); // Wait 4 seconds before next step
                }, DURATION);
            }
            nextStep();
        }

        // --- AI TUTOR (omitted for brevity) ---
        
        // --- INITIALIZATION ---
        function init() {
            const controlsContainer = d3.select("#controls-container");
            Object.entries(params).forEach(([key, p]) => {
                controlsContainer.html(controlsContainer.html() + `
                    <div>
                        <label for="${key}" class="flex justify-between text-sm font-medium text-slate-600">
                            <span>${p.label} ($${p.symbol}$)</span><span id="${key}-value" class="font-semibold text-slate-800"></span>
                        </label>
                        <input type="range" id="${key}" min="${p.min}" max="${p.max}" value="${p.value}" step="${p.step}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>`);
            });

            [adasChart.svg, challengeChart.svg, empiricalChart.svg].forEach(svg => {
                svg.append("g").attr("class", "x-axis").attr("transform", `translate(0,${adasChart.height})`);
                svg.append("g").attr("class", "y-axis");
                svg.append("line").attr("class", "lras-curve").attr("y1", 0).attr("y2", adasChart.height).attr("stroke", COLORS.lras).attr("stroke-width", 3);
                svg.append("path").attr("class", "ad-curve").attr("fill", "none").attr("stroke", COLORS.ad).attr("stroke-width", 3);
                svg.append("line").attr("class", "sras-curve").attr("stroke", COLORS.sras).attr("stroke-width", 2).attr("stroke-dasharray", "4 4").style("opacity", 0);
                svg.append("path").attr("class", "dynamic-path").attr("fill", "none").attr("stroke", COLORS.path).attr("stroke-width", 2.5);
                svg.append("path").attr("class", "real-data-path").attr("fill", "none").attr("stroke", COLORS.real_data).attr("stroke-width", 3).attr("stroke-dasharray", "3 3");
                svg.append("circle").attr("class", "start-point").attr("r", 6).attr("fill", COLORS.path);
                svg.append("circle").attr("class", "equilibrium-point").attr("r", 6).attr("fill", COLORS.equilibrium).attr("stroke", "white").attr("stroke-width", 2);
            });

            [yPathChart.svg, pPathChart.svg].forEach((svg, i) => {
                svg.append("g").attr("class", "x-axis").attr("transform", `translate(0,${yPathChart.height})`);
                svg.append("g").attr("class", "y-axis");
                svg.append("path").attr("class", "path").attr("fill", "none").attr("stroke", i === 0 ? COLORS.y_path : COLORS.p_path).attr("stroke-width", 2.5);
                svg.append("line").attr("class", "equilibrium-line").attr("x1", 0).attr("x2", yPathChart.width).attr("stroke", COLORS.equilibrium).attr("stroke-width", 1.5).attr("stroke-dasharray", "4 4");
            });

            Object.keys(params).forEach(key => d3.select(`#${key}`).on("input", render));
            d3.select("#back-to-challenges").on('click', renderChallengeSelection);
            d3.select("#guided-tour-btn").on('click', startGuidedTour);

            setupTabs();
            setupEmpiricalBridge();
            render();
        }

        init();
    </script>
</body>
</html>
