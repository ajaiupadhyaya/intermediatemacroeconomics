<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive GDP Measurement: The Expenditure Approach</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKZC0svKNUROgsE7FVU2TwuUmdlNP9GGUo2CRI3BlgN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .katex { font-size: 1.1em; }
        .section-title { font-family: 'Source Serif 4', serif; font-weight: 600; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-900 tracking-tight sm:text-5xl section-title">GDP: The Expenditure Approach</h1>
            <p class="mt-3 text-lg text-slate-600 max-w-4xl mx-auto">Adjust the components of spending to see how they contribute to the nation's Gross Domestic Product (GDP).</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Parameters</h2>
                    <div id="controls-container" class="space-y-5">
                        </div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Core Equation</h2>
                    <div id="equation-container" class="p-4 bg-slate-50 rounded-md text-center"></div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Summary</h2>
                    <div id="summary-container" class="text-sm text-slate-700 leading-relaxed space-y-2">
                       </div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white p-4 sm:p-6 rounded-2xl shadow-xl border border-slate-200 min-h-[500px]">
                <h3 class="text-xl font-semibold text-slate-700 text-center mb-4">GDP Components | Total GDP (Y) = <span id="total-gdp-display" class="text-blue-600"></span></h3>
                <div id="graph-container"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const DURATION = 400;
        const COLORS = { C: '#5DADE2', I: '#48C9B0', G: '#F5B041', NX: '#A569BD' };

        // --- STATE MANAGEMENT ---
        let state = {};

        const params = {
            C: { min: 0, max: 5000, value: 2000, step: 100, label: "Consumption (C)" },
            I: { min: -500, max: 2000, value: 500, step: 50, label: "Investment (I)" },
            G: { min: 0, max: 3000, value: 1000, step: 100, label: "Government (G)" },
            NX: { min: -1000, max: 1000, value: -200, step: 50, label: "Net Exports (NX)" }
        };

        // --- D3 SETUP ---
        const margin = { top: 20, right: 20, bottom: 40, left: 60 };
        const container = document.getElementById('graph-container');
        const width = container.clientWidth - margin.left - margin.right;
        const height = 450 - margin.top - margin.bottom;

        const svg = d3.select("#graph-container").append("svg")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleBand().range([0, width * 0.6]).padding(0.3); // Bar chart takes 60% of width
        const yScale = d3.scaleLinear().range([height, 0]);

        const xAxis = svg.append("g").attr("transform", `translate(0,${height})`);
        const yAxis = svg.append("g");
        svg.append("line").attr("class", "zero-line")
            .attr("x1", 0).attr("x2", width * 0.6)
            .attr("stroke", "black").attr("stroke-width", 0.5);

        const barGroup = svg.append("g");
        const pieGroup = svg.append("g").attr("transform", `translate(${width * 0.8}, ${height / 2})`);


        // --- CORE LOGIC ---
        function calculateState() {
            Object.keys(params).forEach(key => state[key] = +d3.select(`#${key}`).property("value"));
            state.Y = state.C + state.I + state.G + state.NX;

            state.components = [
                { key: 'C', value: state.C },
                { key: 'I', value: state.I },
                { key: 'G', value: state.G },
                { key: 'NX', value: state.NX }
            ];

            state.pieData = state.components.filter(d => d.value > 0);
        }

        function render() {
            const t = d3.transition().duration(DURATION).ease(d3.easeCubicOut);
            calculateState();

            // --- Update UI Text ---
            const formatCurrency = d3.format("$,.0f");
            d3.select("#total-gdp-display").text(formatCurrency(state.Y));
            Object.entries(params).forEach(([key, p]) => {
                d3.select(`#${key}-value`).text(formatCurrency(state[key]));
            });

            // --- Render Bar Chart ---
            const values = state.components.map(d => d.value);
            const yMax = d3.max(values);
            const yMin = d3.min(values);
            yScale.domain([Math.min(0, yMin), Math.max(0, yMax)]);
            xScale.domain(state.components.map(d => d.key));

            yAxis.transition(t).call(d3.axisLeft(yScale).tickFormat(d3.format("$,.0f")));
            xAxis.call(d3.axisBottom(xScale).tickSize(0).tickPadding(10));
            svg.select(".zero-line").transition(t).attr("y1", yScale(0)).attr("y2", yScale(0));

            barGroup.selectAll("rect")
                .data(state.components, d => d.key)
                .join("rect")
                .attr("fill", d => COLORS[d.key])
                .transition(t)
                .attr("x", d => xScale(d.key))
                .attr("width", xScale.bandwidth())
                .attr("y", d => d.value > 0 ? yScale(d.value) : yScale(0))
                .attr("height", d => Math.abs(yScale(0) - yScale(d.value)));

            // --- Render Pie Chart ---
            const pieRadius = Math.min(width * 0.2, height / 2) * 0.9;
            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(pieRadius * 0.5).outerRadius(pieRadius);

            pieGroup.selectAll("path")
                .data(pie(state.pieData), d => d.data.key)
                .join(
                    enter => enter.append("path")
                        .attr("fill", d => COLORS[d.data.key])
                        .attr("d", arc)
                        .each(function(d) { this._current = d; }),
                    update => update,
                    exit => exit.transition(t).attrTween("d", function(d) {
                        const i = d3.interpolate(this._current, { ...this._current, startAngle: this._current.endAngle });
                        return t => arc(i(t));
                    }).remove()
                )
                .transition(t)
                .attrTween("d", function(d) {
                    const i = d3.interpolate(this._current, d);
                    this._current = i(0);
                    return t => arc(i(t));
                });

            // --- Render Summary ---
            const formatPercent = d3.format(".1%");
            let summaryHtml = state.components.map(d => `
                <div class="flex justify-between">
                    <span>â€¢ ${params[d.key].label}:</span>
                    <span class="font-semibold">${formatCurrency(d.value)} (${state.Y !== 0 ? formatPercent(d.value/state.Y) : 'N/A'})</span>
                </div>
            `).join("");
            summaryHtml += `<div class="flex justify-between border-t pt-2 mt-2">
                                <span class="font-bold">Total GDP (Y):</span>
                                <span class="font-bold">${formatCurrency(state.Y)}</span>
                           </div>`;
            d3.select("#summary-container").html(summaryHtml);
        }

        function init() {
            // --- Initialize Controls ---
            const controlsContainer = d3.select("#controls-container");
            Object.entries(params).forEach(([key, p]) => {
                const controlHtml = `
                    <div>
                        <label for="${key}" class="flex justify-between text-sm font-medium text-slate-600">
                            <span>${p.label}</span>
                            <span id="${key}-value" class="font-semibold text-slate-800"></span>
                        </label>
                        <input type="range" id="${key}" min="${p.min}" max="${p.max}" value="${p.value}" step="${p.step}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>`;
                controlsContainer.html(controlsContainer.html() + controlHtml);
            });

            // --- Render Equation ---
            katex.render("Y = C + I + G + NX", document.getElementById('equation-container'), { throwOnError: false });

            // --- Add Event Listeners ---
            Object.keys(params).forEach(key => d3.select(`#${key}`).on("input", render));

            // --- Initial Render ---
            render();
        }

        init();
    </script>
</body>
</html>