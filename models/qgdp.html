<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Quarterly GDP and Growth Rates</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKZC0svKNUROgsE7FVU2TwuUmdlNP9GGUo2CRI3BlgN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .katex { font-size: 1.1em; }
        .section-title { font-family: 'Source Serif 4', serif; font-weight: 600; }
        .domain { stroke-width: 1.5; }
        .tick line { stroke: #e2e8f0; }
        .axis-label { font-size: 0.8rem; fill: #475569; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-900 tracking-tight sm:text-5xl section-title">Quarterly GDP & Growth Rates</h1>
            <p class="mt-3 text-lg text-slate-600 max-w-4xl mx-auto">Set the GDP level for each quarter to see how quarter-over-quarter (QoQ) and annualized growth rates are calculated.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">GDP Levels</h2>
                    <div id="controls-container" class="space-y-5">
                        </div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Formulas</h2>
                    <div id="equations-container" class="space-y-4"></div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h2 class="text-2xl text-slate-800 border-b pb-3 mb-4 section-title">Growth Summary</h2>
                    <div id="summary-table-container" class="text-sm"></div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white p-4 sm:p-6 rounded-2xl shadow-xl border border-slate-200 min-h-[500px]">
                 <div id="graph-container"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const DURATION = 400;
        const COLORS = { level: 'lightblue', qoq: 'darkorange', annualized: 'darkgreen' };

        // --- STATE MANAGEMENT ---
        let state = {};

        const params = {
            q1: { value: 5000, label: "Q1 GDP" },
            q2: { value: 5100, label: "Q2 GDP" },
            q3: { value: 5200, label: "Q3 GDP" },
            q4: { value: 5300, label: "Q4 GDP" }
        };
        const shared = { min: 1000, max: 10000, step: 50 };

        // --- D3 SETUP ---
        const margin = { top: 20, right: 60, bottom: 40, left: 70 };
        const container = document.getElementById('graph-container');
        const width = container.clientWidth - margin.left - margin.right;
        const height = 450 - margin.top - margin.bottom;

        const svg = d3.select("#graph-container").append("svg")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale = d3.scaleBand().range([0, width]).padding(0.4).domain(['Q1', 'Q2', 'Q3', 'Q4']);
        const y0Scale = d3.scaleLinear().range([height, 0]); // Left axis for levels
        const y1Scale = d3.scaleLinear().range([height, 0]); // Right axis for growth

        const xAxis = svg.append("g").attr("transform", `translate(0,${height})`);
        const y0Axis = svg.append("g").attr("class", "y0-axis");
        const y1Axis = svg.append("g").attr("class", "y1-axis").attr("transform", `translate(${width},0)`);

        svg.append("g").attr("class", "grid");
        const barGroup = svg.append("g");
        const qoqLinePath = svg.append("path").attr("fill", "none").attr("stroke", COLORS.qoq).attr("stroke-width", 2).attr("stroke-dasharray", "5 5");
        const annLinePath = svg.append("path").attr("fill", "none").attr("stroke", COLORS.annualized).attr("stroke-width", 2.5);
        const qoqDots = svg.append("g");
        const annDots = svg.append("g");
        
        // --- CORE LOGIC ---
        function calculateState() {
            const levels = Object.keys(params).map(key => +d3.select(`#${key}`).property("value"));
            state.data = levels.map((level, i) => {
                const quarter = `Q${i+1}`;
                let qoq = null, annualized = null;
                if (i > 0 && levels[i-1] > 0) {
                    qoq = (levels[i] / levels[i-1]) - 1;
                    annualized = Math.pow(1 + qoq, 4) - 1;
                }
                return { quarter, level, qoq, annualized };
            });
        }

        function render() {
            const t = d3.transition().duration(DURATION).ease(d3.easeCubicOut);
            calculateState();

            // --- Update UI Text ---
            const formatCurrency = d3.format("$,.0f");
            Object.keys(params).forEach((key, i) => {
                d3.select(`#${key}-value`).text(formatCurrency(state.data[i].level));
            });

            // --- Update Scales & Axes ---
            const maxLevel = d3.max(state.data, d => d.level);
            y0Scale.domain([0, maxLevel * 1.1]);
            
            const growthRates = state.data.flatMap(d => [d.qoq, d.annualized]).filter(d => d !== null);
            const growthExtent = d3.extent(growthRates);
            const growthPadding = (growthExtent[1] - growthExtent[0]) * 0.1;
            y1Scale.domain([growthExtent[0] - growthPadding, growthExtent[1] + growthPadding]);

            xAxis.call(d3.axisBottom(xScale).tickSize(0).tickPadding(10));
            y0Axis.transition(t).call(d3.axisLeft(y0Scale).ticks(5).tickFormat(d3.format("$,.0f")));
            y1Axis.transition(t).call(d3.axisRight(y1Scale).ticks(5).tickFormat(d3.format(".1%")));

            // --- Render Bars ---
            barGroup.selectAll("rect")
                .data(state.data)
                .join("rect")
                .attr("fill", COLORS.level)
                .transition(t)
                .attr("x", d => xScale(d.quarter))
                .attr("width", xScale.bandwidth())
                .attr("y", d => y0Scale(d.level))
                .attr("height", d => height - y0Scale(d.level));
            
            // --- Render Lines ---
            const lineGenerator = (yValue) => d3.line()
                .x(d => xScale(d.quarter) + xScale.bandwidth() / 2)
                .y(d => y1Scale(yValue(d)))
                .defined(d => yValue(d) !== null);

            qoqLinePath.datum(state.data).transition(t).attr("d", lineGenerator(d => d.qoq));
            annLinePath.datum(state.data).transition(t).attr("d", lineGenerator(d => d.annualized));

            // --- Render Dots ---
            const renderDots = (selection, data, yValue, color) => {
                selection.selectAll("circle")
                    .data(data.filter(d => yValue(d) !== null))
                    .join("circle")
                    .attr("r", 4)
                    .attr("fill", color)
                    .transition(t)
                    .attr("cx", d => xScale(d.quarter) + xScale.bandwidth() / 2)
                    .attr("cy", d => y1Scale(yValue(d)));
            };
            renderDots(qoqDots, state.data, d => d.qoq, COLORS.qoq);
            renderDots(annDots, state.data, d => d.annualized, COLORS.annualized);

            // --- Render Summary Table ---
            const formatPercent = d3.format("+.2%");
            const tableHeader = `<div class="grid grid-cols-4 gap-2 font-bold border-b pb-2 mb-2">
                                    <span>Quarter</span><span class="text-right">GDP Level</span><span class="text-right">QoQ</span><span class="text-right">Annualized</span>
                                 </div>`;
            const tableRows = state.data.map(d => `
                <div class="grid grid-cols-4 gap-2 border-b py-1">
                    <span>${d.quarter}</span>
                    <span class="text-right font-mono">${formatCurrency(d.level)}</span>
                    <span class="text-right font-mono">${d.qoq !== null ? formatPercent(d.qoq) : '---'}</span>
                    <span class="text-right font-mono text-green-700 font-semibold">${d.annualized !== null ? formatPercent(d.annualized) : '---'}</span>
                </div>
            `).join("");
            d3.select("#summary-table-container").html(tableHeader + tableRows);
        }

        function init() {
            const controlsContainer = d3.select("#controls-container");
            Object.entries(params).forEach(([key, p]) => {
                const controlHtml = `
                    <div>
                        <label for="${key}" class="flex justify-between text-sm font-medium text-slate-600">
                            <span>${p.label}</span>
                            <span id="${key}-value" class="font-semibold text-slate-800"></span>
                        </label>
                        <input type="range" id="${key}" min="${shared.min}" max="${shared.max}" value="${p.value}" step="${shared.step}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>`;
                controlsContainer.html(controlsContainer.html() + controlHtml);
            });

            const equationsContainer = d3.select("#equations-container");
            equationsContainer.html(`
                <div id="qoq-eq" class="p-3 bg-slate-50 rounded-md"></div>
                <div id="ann-eq" class="p-3 bg-slate-50 rounded-md"></div>
            `);
            katex.render("g_{q} = \\frac{GDP_t}{GDP_{t-1}} - 1", document.getElementById('qoq-eq'), { throwOnError: false });
            katex.render("g_{a} = (1 + g_{q})^4 - 1", document.getElementById('ann-eq'), { throwOnError: false });
            
            Object.keys(params).forEach(key => d3.select(`#${key}`).on("input", render));

            render();
        }

        init();
    </script>
</body>
</html>